–¶–µ –¥—É–∂–µ —Å–ª—É—à–Ω—ñ –∑–∞—É–≤–∞–∂–µ–Ω–Ω—è. –ì—Ä–∞—Ç–∏ –Ω–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—ñ —ñ —Å—Ç—Ä—ñ–ª—è—Ç–∏ "–Ω–∞–æ—Å–ª—ñ–ø" —Å–ø—Ä–∞–≤–¥—ñ –Ω–µ–∑—Ä—É—á–Ω–æ.

–û—Å—å **–í–µ–ª–∏–∫–µ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ì–µ–π–º–ø–ª–µ—é**, —è–∫–µ –≤–∏—Ä—ñ—à—É—î –≤—Å—ñ —Ç–≤–æ—ó –ø—Ä–æ–±–ª–µ–º–∏:

1. **–ö–µ—Ä—É–≤–∞–Ω–Ω—è –ú–∏—à–∫–æ—é (Aiming):** –¢–µ–ø–µ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂ **–ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –∑–∞ –∫—É—Ä—Å–æ—Ä–æ–º –º–∏—à—ñ**. –ú–∞–≥ —Å—Ç—Ä—ñ–ª—è—î —Ç–æ—á–Ω–æ —Ç—É–¥–∏, –∫—É–¥–∏ —Ç–∏ —Ü—ñ–ª–∏—à—Å—è. –í–æ—ó–Ω –±'—î –º–µ—á–µ–º —É –±—ñ–∫ –∫—É—Ä—Å–æ—Ä–∞.
2. **–û–±–ª–∏—á—á—è:** –î–æ–¥–∞–≤ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º "–æ—á—ñ", —â–æ–± —Ç–∏ –±–∞—á–∏–≤, –∫—É–¥–∏ –≤–æ–Ω–∏ –¥–∏–≤–ª—è—Ç—å—Å—è.
3. **–ü–µ—Ä–µ—à–∫–æ–¥–∏ (–°–∫–µ–ª—ñ):** –ù–∞ –∫–∞—Ä—Ç—ñ —Ç–µ–ø–µ—Ä –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è —Å—ñ—Ä—ñ –∫–∞–º–µ–Ω—ñ. –ö—Ä—ñ–∑—å –Ω–∏—Ö –Ω–µ –º–æ–∂–Ω–∞ –ø—Ä–æ–π—Ç–∏ —ñ –∫—Ä—ñ–∑—å –Ω–∏—Ö –Ω–µ –ø—Ä–æ–ª—ñ—Ç–∞—é—Ç—å –∫—É–ª—ñ. –¶–µ —Å—Ç–≤–æ—Ä—é—î —Ç–∞–∫—Ç–∏–∫—É (–º–æ–∂–Ω–∞ —Ö–æ–≤–∞—Ç–∏—Å—è).
4. **–ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ "–ó–∞–ª–∏–ø–∞–Ω–Ω—è" (Blur Fix):** –Ø–∫—â–æ —Ç–∏ –∑–≤–µ—Ä–Ω–µ—à –≤—ñ–∫–Ω–æ –∞–±–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—à –≤–∫–ª–∞–¥–∫—É, –ø–µ—Ä—Å–æ–Ω–∞–∂ –º–∏—Ç—Ç—î–≤–æ –∑—É–ø–∏–Ω–∏—Ç—å—Å—è, –∞ –Ω–µ –ø–æ–±—ñ–∂–∏—Ç—å —É –±–µ–∑–∫—ñ–Ω–µ—á–Ω—ñ—Å—Ç—å.

### –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è:

1. **–û—á–∏—Å—Ç–∏ –±–∞–∑—É Firebase** (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ, –±–æ –¥–æ–¥–∞—é—Ç—å—Å—è –∫–∞–º–µ–Ω—ñ `obstacles`).
2. –ó–∞–º—ñ–Ω–∏ –∫–æ–¥.

```html
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>RPG IO: Tactics Update</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Segoe UI', sans-serif; color: white; user-select: none; }
        canvas { display: block; cursor: crosshair; } /* –ö—É—Ä—Å–æ—Ä-–ø—Ä–∏—Ü—ñ–ª */

        /* –ï–ö–†–ê–ù –í–ò–ë–û–†–£ */
        #startScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100;
        }
        .class-container { display: flex; gap: 20px; margin: 20px; }
        .class-card {
            background: #222; border: 2px solid #444; padding: 20px; border-radius: 10px;
            cursor: pointer; width: 150px; text-align: center; transition: 0.2s;
        }
        .class-card:hover { transform: scale(1.05); border-color: white; }
        .class-card.selected { border-color: lime; background: #1a331a; box-shadow: 0 0 15px lime; }
        .class-icon { font-size: 50px; margin-bottom: 10px; }
        
        input { padding: 15px; font-size: 20px; border-radius: 8px; border: none; text-align: center; width: 250px; }
        #playBtn { 
            padding: 15px 50px; font-size: 24px; font-weight: bold; margin-top: 20px;
            background: linear-gradient(45deg, #ff416c, #ff4b2b); border: none; border-radius: 50px; color: white; cursor: pointer;
        }

        /* HUD */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
        
        #stats { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px; width: 220px; }
        .bar-wrap { margin-top: 5px; position: relative; height: 12px; background: #333; border-radius: 6px; overflow: hidden; }
        .bar-val { height: 100%; transition: width 0.2s; }
        .bar-text { position: absolute; top: 0; left: 0; width: 100%; text-align: center; font-size: 10px; line-height: 12px; text-shadow: 1px 1px 1px black; }
        
        #cooldown-bar { 
            position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%);
            width: 200px; height: 8px; background: #444; border-radius: 4px; overflow: hidden;
        }
        #cd-fill { width: 100%; height: 100%; background: #00ccff; }

        #inventory { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
        .slot { 
            width: 60px; height: 60px; background: #222; border: 2px solid #555; border-radius: 8px;
            display: flex; justify-content: center; align-items: center; font-size: 28px; position: relative;
        }
        .key { position: absolute; top: 2px; left: 5px; font-size: 10px; color: #888; }
    </style>
</head>
<body>

    <div id="startScreen">
        <h1>BATTLE IO</h1>
        <input type="text" id="nick" placeholder="–¢–≤—ñ–π –ù—ñ–∫" maxlength="12">
        
        <div class="class-container">
            <div class="class-card selected" onclick="selectClass('warrior')" id="card-warrior">
                <div class="class-icon">‚öîÔ∏è</div>
                <h3>–í–û–á–ù</h3>
                <small>–ñ–∏–≤—É—á–∏–π<br>–£–¥–∞—Ä –ø–æ –¥—É–∑—ñ</small>
            </div>
            <div class="class-card" onclick="selectClass('mage')" id="card-mage">
                <div class="class-icon">üîÆ</div>
                <h3>–ú–ê–ì</h3>
                <small>–°–∫–ª—è–Ω–∞ –≥–∞—Ä–º–∞—Ç–∞<br>–¢–æ—á–Ω–∞ —Å—Ç—Ä—ñ–ª—å–±–∞</small>
            </div>
        </div>

        <button id="playBtn">–ì–†–ê–¢–ò</button>
        <p style="color:#888; margin-top:10px">WASD - –†—É—Ö | –ú–∏—à–∫–∞ - –¶—ñ–ª—å | –õ–ö–ú/F - –ê—Ç–∞–∫–∞</p>
    </div>

    <div id="ui-layer">
        <div id="stats">
            <b id="uiName" style="font-size: 18px;">Player</b> <span id="uiClass" style="color:yellow; font-size:12px"></span>
            <div style="font-size: 12px; margin-top: 4px; color: #ccc;">–†—ñ–≤–µ–Ω—å <span id="uiLvl" style="color:gold">1</span></div>
            <div class="bar-wrap"><div id="hp-fill" class="bar-val" style="background:#ff3333; width:100%"></div><div id="hp-text" class="bar-text">100/100</div></div>
            <div class="bar-wrap"><div id="xp-fill" class="bar-val" style="background:#3388ff; width:0%"></div><div id="xp-text" class="bar-text">0%</div></div>
        </div>
        <div id="cooldown-bar"><div id="cd-fill"></div></div>
        <div id="inventory">
            <div class="slot"><span class="key">1</span><span id="item0"></span></div>
            <div class="slot"><span class="key">2</span><span id="item1"></span></div>
            <div class="slot"><span class="key">3</span><span id="item2"></span></div>
        </div>
    </div>

    <canvas id="game"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, update, remove, push, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBSNd99iZQE3OawjoN0G0KAsyBOoIxUJow",
            authDomain: "my-io-game.firebaseapp.com",
            databaseURL: "https://my-io-game-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "my-io-game",
            storageBucket: "my-io-game.firebasestorage.app",
            messagingSenderId: "611910695781",
            appId: "1:611910695781:web:5124e62f4aa4139f9c7f8c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");
        
        // --- Game State ---
        let myId = null;
        let players = {};
        let food = {};
        let chests = {};
        let projectiles = {};
        let obstacles = {}; // –ö–∞–º–µ–Ω—ñ
        let selectedClass = 'warrior';

        let myData = { 
            x: 0, y: 0, hp: 100, maxHp: 100, xp: 0, lvl: 1, 
            class: 'warrior', inv: [null, null, null], 
            angle: 0, speedBuff: 1
        };

        let lastAttackTime = 0;
        let keys = {};
        let mouseX = 0, mouseY = 0; // –î–ª—è –ø—Ä–∏—Ü—ñ–ª—é–≤–∞–Ω–Ω—è

        const CLASSES = {
            warrior: { hp: 150, speed: 4, color: '#3498db', cooldown: 500, range: 90 },
            mage:    { hp: 90,  speed: 4, color: '#9b59b6', cooldown: 800, range: 600 }
        };

        // --- UI ---
        window.selectClass = (cls) => {
            selectedClass = cls;
            document.querySelectorAll('.class-card').forEach(el => el.classList.remove('selected'));
            document.getElementById(`card-${cls}`).classList.add('selected');
        };

        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
        window.dispatchEvent(new Event('resize'));

        document.getElementById("playBtn").onclick = () => {
            const nick = document.getElementById("nick").value;
            if(!nick) return alert("–í–≤–µ–¥–∏ –Ω—ñ–∫!");

            myData.name = nick;
            myData.class = selectedClass;
            myData.maxHp = CLASSES[selectedClass].hp;
            myData.hp = myData.maxHp;
            // –°–ø–∞–≤–Ω –ø–æ–¥–∞–ª—ñ –≤—ñ–¥ —Ü–µ–Ω—Ç—Ä—É
            myData.x = (Math.random()-0.5)*1500;
            myData.y = (Math.random()-0.5)*1500;

            document.getElementById("startScreen").style.display = 'none';
            document.getElementById("ui-layer").style.display = 'block';

            initGame();
        };

        function initGame() {
            signInAnonymously(auth).then(cred => {
                myId = cred.user.uid;
                
                const myRef = ref(db, `players/${myId}`);
                set(myRef, myData);
                onDisconnect(myRef).remove();

                onValue(ref(db, 'players'), s => players = s.val() || {});
                onValue(ref(db, 'food'), s => food = s.val() || {});
                onValue(ref(db, 'chests'), s => chests = s.val() || {});
                onValue(ref(db, 'projectiles'), s => projectiles = s.val() || {});
                onValue(ref(db, 'obstacles'), s => obstacles = s.val() || {});

                setInterval(() => { if(Math.random() > 0.5) spawnWorldObjects(); }, 1000);
                gameLoop();
            });
        }

        function spawnWorldObjects() {
            // –õ—ñ–º—ñ—Ç–∏ –æ–±'—î–∫—Ç—ñ–≤
            if(Object.keys(food).length < 60) push(ref(db, 'food'), { x: (Math.random()-0.5)*3000, y: (Math.random()-0.5)*3000 });
            if(Object.keys(chests).length < 20 && Math.random()>0.8) push(ref(db, 'chests'), { x: (Math.random()-0.5)*3000, y: (Math.random()-0.5)*3000 });
            
            // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –ø–µ—Ä–µ—à–∫–æ–¥ (–ö–∞–º–µ–Ω—ñ), —è–∫—â–æ —ó—Ö –º–∞–ª–æ
            if(Object.keys(obstacles).length < 30) {
                push(ref(db, 'obstacles'), { 
                    x: (Math.random()-0.5)*2800, 
                    y: (Math.random()-0.5)*2800,
                    w: 60 + Math.random()*100, // –í–∏–ø–∞–¥–∫–æ–≤–∏–π —Ä–æ–∑–º—ñ—Ä
                    h: 60 + Math.random()*100
                });
            }
        }

        // --- Controls ---
        window.addEventListener('keydown', e => {
            keys[e.code] = true;
            if(['Digit1','Digit2','Digit3'].includes(e.code)) useItem(parseInt(e.code.slice(-1))-1);
            if(e.code === 'KeyF') tryAttack(); // –ê—Ç–∞–∫–∞ –∫–ª–∞–≤—ñ—à–æ—é F
        });
        
        window.addEventListener('keyup', e => keys[e.code] = false);
        
        // –§—ñ–∫—Å –∑–∞–ª–∏–ø–∞–Ω–Ω—è –∫–ª–∞–≤—ñ—à (—è–∫—â–æ –∑–≥–æ—Ä–Ω—É–ª–∏ –≤—ñ–∫–Ω–æ)
        window.addEventListener('blur', () => { keys = {}; });

        // –ú–∏—à–∫–∞
        window.addEventListener('mousemove', e => {
            mouseX = e.clientX;
            mouseY = e.clientY;
        });
        window.addEventListener('mousedown', () => tryAttack()); // –ê—Ç–∞–∫–∞ –º–∏—à–∫–æ—é

        function useItem(idx) {
            const item = myData.inv[idx];
            if(!item) return;
            if(item === 'üíä') myData.hp = Math.min(myData.maxHp, myData.hp + 50);
            if(item === '‚ö°') { myData.speedBuff = 2; setTimeout(() => myData.speedBuff = 1, 4000); }
            myData.inv[idx] = null;
        }

        // --- Logic ---
        function checkCollision(x, y) {
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑—ñ—Ç–∫–Ω–µ–Ω–Ω—è –∑ –∫–∞–º—ñ–Ω–Ω—è–º
            const size = 20; // –†–∞–¥—ñ—É—Å –≥—Ä–∞–≤—Ü—è
            for(let key in obstacles) {
                const obs = obstacles[key];
                // –ü—Ä–æ—Å—Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫—ñ–≤
                if (x + size > obs.x && x - size < obs.x + obs.w &&
                    y + size > obs.y && y - size < obs.y + obs.h) {
                    return true;
                }
            }
            return false;
        }

        function gameLoop() {
            if(myId) updateGame();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function updateGame() {
            // 1. –ü–æ–≤–æ—Ä–æ—Ç –∑–∞ –º–∏—à–∫–æ—é
            // –¶–µ–Ω—Ç—Ä –µ–∫—Ä–∞–Ω—É = –≥—Ä–∞–≤–µ—Ü—å
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            myData.angle = Math.atan2(mouseY - centerY, mouseX - centerX);

            // 2. –†—É—Ö –∑ –∫–æ–ª—ñ–∑—ñ—î—é
            const speed = CLASSES[myData.class].speed * myData.speedBuff * (keys['ShiftLeft'] ? 1.5 : 1);
            let dx = 0, dy = 0;
            if(keys['KeyW']) dy -= speed;
            if(keys['KeyS']) dy += speed;
            if(keys['KeyA']) dx -= speed;
            if(keys['KeyD']) dx += speed;

            // –†—É—Ö–∞—î–º–æ –ø–æ X, –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç—ñ–Ω—É
            if(!checkCollision(myData.x + dx, myData.y)) myData.x += dx;
            // –†—É—Ö–∞—î–º–æ –ø–æ Y, –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç—ñ–Ω—É
            if(!checkCollision(myData.x, myData.y + dy)) myData.y += dy;

            // 3. –ó–±—ñ—Ä
            Object.keys(food).forEach(fid => {
                if(Math.hypot(myData.x - food[fid].x, myData.y - food[fid].y) < 40) {
                    remove(ref(db, `food/${fid}`));
                    myData.xp += 10;
                    myData.hp = Math.min(myData.maxHp, myData.hp + 5);
                    checkLevelUp();
                }
            });
            Object.keys(chests).forEach(cid => {
                if(Math.hypot(myData.x - chests[cid].x, myData.y - chests[cid].y) < 50) {
                    remove(ref(db, `chests/${cid}`));
                    myData.xp += 50;
                    checkLevelUp();
                    for(let i=0; i<3; i++) if(!myData.inv[i]) { myData.inv[i] = Math.random()>0.5 ? 'üíä' : '‚ö°'; break; }
                }
            });

            // 4. –ö—É–ª—ñ (Projectiles)
            Object.keys(projectiles).forEach(pid => {
                const proj = projectiles[pid];
                
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑—ñ—Ç–∫–Ω–µ–Ω–Ω—è –∑ –∫–∞–º—ñ–Ω–Ω—è–º (–∫—É–ª—è –∑–Ω–∏–∫–∞—î)
                // –ê–ª–µ —â–æ–± –Ω–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏, –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ç—ñ–ª—å–∫–∏ "—Å–≤–æ—ó" –∫—É–ª—ñ –∞–±–æ –∫–æ–ª–∏ –º–∞–ª—é—î–º–æ
                // –¢—É—Ç –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞: —á–∏ –≤–ª—É—á–∏–ª–∏ –≤ –º–µ–Ω–µ
                if(proj.owner !== myId) {
                    if(Math.hypot(myData.x - proj.x, myData.y - proj.y) < 30) {
                        myData.hp -= 15;
                        remove(ref(db, `projectiles/${pid}`));
                    }
                }
                
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫—É–ª—ñ –æ–± —Å—Ç—ñ–Ω—É (—è–∫—â–æ —è –≤–ª–∞—Å–Ω–∏–∫, —è –≤–∏–¥–∞–ª—è—é)
                if(proj.owner === myId) {
                    if(checkCollision(proj.x, proj.y)) remove(ref(db, `projectiles/${pid}`));
                    if(Date.now() - proj.created > 2000) remove(ref(db, `projectiles/${pid}`));
                }
            });

            if(myData.hp <= 0) {
                myData.hp = myData.maxHp;
                myData.x = (Math.random()-0.5)*1500;
                myData.y = (Math.random()-0.5)*1500;
                myData.inv = [null,null,null];
            }

            // Sync
            update(ref(db, `players/${myId}`), myData);
            
            // UI Update
            const cdTime = CLASSES[myData.class].cooldown;
            const timePassed = Date.now() - lastAttackTime;
            document.getElementById('cd-fill').style.width = Math.min(100, (timePassed/cdTime)*100) + "%";
            updateUI();
        }

        function checkLevelUp() {
            if(myData.xp >= myData.lvl * 100) {
                myData.xp = 0; myData.lvl++; myData.maxHp += 20; myData.hp = myData.maxHp;
            }
        }

        function tryAttack() {
            const now = Date.now();
            const cdTime = CLASSES[myData.class].cooldown;
            if(now - lastAttackTime < cdTime) return; // –©–µ –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞
            
            lastAttackTime = now;
            
            if(myData.class === 'warrior') {
                // –í–æ—ó–Ω –±'—î –≤ —Å–µ–∫—Ç–æ—Ä—ñ –ø–µ—Ä–µ–¥ —Å–æ–±–æ—é
                Object.keys(players).forEach(pid => {
                    if(pid === myId) return;
                    const p = players[pid];
                    const dist = Math.hypot(myData.x - p.x, myData.y - p.y);
                    
                    if(dist < 90) {
                        // –ß–∏ –≤–æ—Ä–æ–≥ –ø–µ—Ä–µ–¥ –Ω–∞–º–∏? (–ö—É—Ç)
                        const angleToEnemy = Math.atan2(p.y - myData.y, p.x - myData.x);
                        const angleDiff = Math.abs(angleToEnemy - myData.angle);
                        // –î–æ–ø—É—Å–∫–∞—î–º–æ –∫—É—Ç —É–¥–∞—Ä—É ~90 –≥—Ä–∞–¥—É—Å—ñ–≤ (PI/2)
                        if(angleDiff < Math.PI/2 || angleDiff > Math.PI*1.5) {
                            update(ref(db, `players/${pid}`), { hp: (p.hp||100) - 25 });
                        }
                    }
                });
            } else {
                // –ú–∞–≥ —Å—Ç—Ä—ñ–ª—è—î —Ç–æ—á–Ω–æ –∑–∞ –∫—É—Ç–æ–º
                push(ref(db, 'projectiles'), {
                    x: myData.x, y: myData.y,
                    vx: Math.cos(myData.angle) * 12,
                    vy: Math.sin(myData.angle) * 12,
                    owner: myId,
                    created: Date.now()
                });
            }
        }

        function updateUI() {
            document.getElementById("uiName").innerText = myData.name;
            document.getElementById("uiClass").innerText = myData.class.toUpperCase();
            document.getElementById("uiLvl").innerText = myData.lvl;
            const hpP = Math.max(0, (myData.hp / myData.maxHp) * 100);
            document.getElementById("hp-fill").style.width = hpP + "%";
            document.getElementById("hp-text").innerText = `${Math.floor(myData.hp)}/${myData.maxHp}`;
            const xpP = (myData.xp / (myData.lvl*100)) * 100;
            document.getElementById("xp-fill").style.width = xpP + "%";
            document.getElementById("xp-text").innerText = `${Math.floor(xpP)}%`;
            for(let i=0; i<3; i++) document.getElementById(`item${i}`).innerText = myData.inv[i] || "";
        }

        function draw() {
            ctx.fillStyle = "#111";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            if(!myId) return;

            const camX = canvas.width/2 - myData.x;
            const camY = canvas.height/2 - myData.y;
            
            ctx.save();
            ctx.translate(camX, camY);

            // Grid
            ctx.strokeStyle = "#222"; ctx.lineWidth = 2; ctx.beginPath();
            const startX = Math.floor((myData.x-canvas.width/2)/100)*100;
            const endX = startX + canvas.width + 200;
            const startY = Math.floor((myData.y-canvas.height/2)/100)*100;
            const endY = startY + canvas.height + 200;
            for(let x=startX; x<=endX; x+=100) { ctx.moveTo(x,startY); ctx.lineTo(x,endY); }
            for(let y=startY; y<=endY; y+=100) { ctx.moveTo(startX,y); ctx.lineTo(endX,y); }
            ctx.stroke();

            // –ü–µ—Ä–µ—à–∫–æ–¥–∏ (–ö–∞–º–µ–Ω—ñ)
            ctx.fillStyle = "#555"; 
            ctx.strokeStyle = "#333";
            ctx.lineWidth = 4;
            Object.values(obstacles).forEach(o => {
                ctx.fillRect(o.x, o.y, o.w, o.h);
                ctx.strokeRect(o.x, o.y, o.w, o.h);
            });

            // Loot
            Object.values(food).forEach(f => {
                ctx.fillStyle = "#2ecc71"; ctx.beginPath(); ctx.arc(f.x, f.y, 8, 0, Math.PI*2); ctx.fill();
            });
            Object.values(chests).forEach(c => {
                ctx.fillStyle = "#f1c40f"; ctx.shadowBlur=10; ctx.shadowColor="gold";
                ctx.fillRect(c.x-15, c.y-15, 30, 30); ctx.shadowBlur=0;
            });

            // Projectiles
            Object.values(projectiles).forEach(p => {
                p.x += p.vx; p.y += p.vy; 
                ctx.fillStyle = "#e74c3c"; ctx.beginPath(); ctx.arc(p.x, p.y, 10, 0, Math.PI*2); ctx.fill();
                // –•–≤—ñ—Å—Ç
                ctx.fillStyle = "rgba(231, 76, 60, 0.3)"; ctx.beginPath(); ctx.arc(p.x - p.vx*2, p.y - p.vy*2, 8, 0, Math.PI*2); ctx.fill();
            });

            // Players
            Object.keys(players).forEach(pid => {
                const p = players[pid];
                if(!p || typeof p.x !== 'number') return;
                
                const size = 30 + (p.lvl||1);
                const isMe = pid === myId;
                const cls = CLASSES[p.class || 'warrior'];

                ctx.save();
                ctx.translate(p.x, p.y);
                
                // –ù—ñ–∫
                ctx.fillStyle = "white"; ctx.font="12px Arial"; ctx.textAlign="center";
                ctx.fillText(`LVL ${p.lvl} ${p.name}`, 0, -size/2 - 20);
                
                // HP
                ctx.fillStyle = "red"; ctx.fillRect(-20, -size/2 - 15, 40, 4);
                ctx.fillStyle = "#0f0"; ctx.fillRect(-20, -size/2 - 15, 40 * ((p.hp||100)/(p.maxHp||100)), 4);

                // –ü–æ–≤–æ—Ä–æ—Ç —Ç—ñ–ª–∞
                ctx.rotate(p.angle || 0);

                // –ê–Ω—ñ–º–∞—Ü—ñ—è —É–¥–∞—Ä—É –≤–æ—ó–Ω–∞
                if(p.class === 'warrior' && isMe && Date.now() - lastAttackTime < 150) {
                     ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
                     ctx.beginPath();
                     ctx.arc(0, 0, 70, -Math.PI/3, Math.PI/3); // –°–µ–∫—Ç–æ—Ä —É–¥–∞—Ä—É
                     ctx.fill();
                }

                // –¢—ñ–ª–æ
                ctx.fillStyle = cls.color;
                ctx.beginPath();
                ctx.roundRect(-size/2, -size/2, size, size, 8);
                ctx.fill();

                // –û–ß–Ü (—â–æ–± –±–∞—á–∏—Ç–∏ –Ω–∞–ø—Ä—è–º–æ–∫)
                ctx.fillStyle = "white";
                // –õ—ñ–≤–µ –æ–∫–æ
                ctx.beginPath(); ctx.arc(size/4, -size/4, 4, 0, Math.PI*2); ctx.fill();
                // –ü—Ä–∞–≤–µ –æ–∫–æ
                ctx.beginPath(); ctx.arc(size/4, size/4, 4, 0, Math.PI*2); ctx.fill();
                // –ó—ñ–Ω–∏—Ü—ñ
                ctx.fillStyle = "black";
                ctx.beginPath(); ctx.arc(size/4 + 2, -size/4, 2, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(size/4 + 2, size/4, 2, 0, Math.PI*2); ctx.fill();

                // –†—É–∫–∏ –¥–ª—è –º–∞–≥–∞
                if(p.class === 'mage') {
                    ctx.fillStyle = cls.color;
                    ctx.beginPath(); ctx.arc(10, -20, 6, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(10, 20, 6, 0, Math.PI*2); ctx.fill();
                }

                ctx.restore();
            });

            ctx.restore();
            drawCompass();
        }

        function drawCompass() {
            let nearest = null; let minDst = Infinity;
            Object.keys(players).forEach(pid => {
                if (pid === myId) return;
                const d = Math.hypot(players[pid].x - myData.x, players[pid].y - myData.y);
                if (d < minDst) { minDst = d; nearest = players[pid]; }
            });

            if (nearest) {
                const angle = Math.atan2(nearest.y - myData.y, nearest.x - myData.x);
                ctx.save();
                ctx.translate(canvas.width/2, canvas.height/2);
                ctx.rotate(angle);
                ctx.translate(100, 0); 
                ctx.fillStyle = "rgba(255, 100, 100, 0.8)";
                ctx.beginPath(); ctx.moveTo(10, 0); ctx.lineTo(-10, 10); ctx.lineTo(-10, -10); ctx.fill();
                ctx.rotate(-angle);
                ctx.fillStyle = "white"; ctx.font = "bold 14px Arial"; ctx.textAlign = "center";
                ctx.fillText(Math.round(minDst) + "m", 0, 25);
                ctx.restore();
            }
        }
    </script>
</body>
</html>